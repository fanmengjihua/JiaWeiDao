---
import Pagination from "@/layouts/components/Pagination.astro";
import Base from "@/layouts/Base.astro";
import config from "@/config/config.json";
import dateFormat from "@/lib/utils/dateFormat";

let posts = [];

// 只在有运行时环境时查询数据库
if ((Astro.locals as any)?.runtime?.env?.DB) {
  // ⭐ Cloudflare Pages SSR：直接拿 D1
  const { DB } = (Astro.locals as any).runtime.env;

  // 查询文章
  const result = await DB.prepare(`
    SELECT
      slug,
      title,
      description,
      image,
      date
    FROM articles
    WHERE draft = 0
    ORDER BY date DESC
  `).all();

  // 将数据转换为所需的格式
  posts = (result.results ?? []);
}

// 分页逻辑（保持你原来的）
const pageSize = config.settings.pagination;
const totalPages = Math.ceil(posts.length / pageSize);
const currentPosts = posts.slice(0, pageSize);
---
<Base>
  <section class="section">
    <div class="container">
      <div class="row gy-5 gx-4 mb-16">
        {currentPosts.map((post, i: number) => (
          <div class={i === 0 ? "col-12" : "col-12 sm:col-6"}>
            {post.image && (
              <a
                href={`/blog/${post.slug}`}
                class="rounded-lg block hover:text-primary overflow-hidden group"
              >
                <img
                  class="group-hover:scale-[1.03] transition duration-300 w-full"
                  src={post.image}
                  alt={post.title}
                  width={i === 0 ? 925 : 445}
                  height={i === 0 ? 475 : 230}
                />
              </a>
            )}
            <ul class="mt-6 mb-4 flex flex-wrap items-center text-text">
              <li class="mr-5 flex items-center flex-wrap font-medium">
                {dateFormat(post.date!)}
              </li>
            </ul>
            <h3 class="mb-4">
              <a
                href={`/blog/${post.slug}`}
                class="block hover:text-primary transition duration-300"
              >
                {post.title}
              </a>
            </h3>
            <p class="text-text line-clamp-2">{post.description}</p>
          </div>
        ))}
      </div>
      <Pagination currentPage={1} totalPages={totalPages} />
    </div>
  </section>
</Base>
