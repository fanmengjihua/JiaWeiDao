---
import { getSinglePage } from "@/lib/contentParser.astro";
import { slugify } from "@/lib/utils/textConverter";
import categoryMapping from "@/config/categoryMapping.json";

// get taxonomy from frontmatter
export const getTaxonomy = async (collection: any, name: string) => {
  const singlePages = await getSinglePage(collection);
  const taxonomyPages = singlePages.map((page: any) => page.data[name]);
  let taxonomies: string[] = [];
  for (let i = 0; i < taxonomyPages.length; i++) {
    const categoryArray = taxonomyPages[i];
    for (let j = 0; j < categoryArray.length; j++) {
      const categoryName = categoryArray[j];
      const categorySlug = slugify(categoryName)!;
      // 使用分类映射将英文slug转换为中文URL
      const chineseUrl = (categoryMapping as any)[categorySlug] || categorySlug;
      taxonomies.push(chineseUrl);
    }
  }
  const taxonomy = [...new Set(taxonomies)];
  return taxonomy;
};

// get all taxonomies from frontmatter
export const getAllTaxonomy = async (collection: any, name: string) => {
  const singlePages = await getSinglePage(collection);
  const taxonomyPages = singlePages.map((page: any) => page.data[name]);
  let taxonomies: string[] = [];
  for (let i = 0; i < taxonomyPages.length; i++) {
    const categoryArray = taxonomyPages[i];
    for (let j = 0; j < categoryArray.length; j++) {
      const categoryName = categoryArray[j];
      const categorySlug = slugify(categoryName)!;
      // 使用分类映射将英文slug转换为中文URL
      const chineseUrl = (categoryMapping as any)[categorySlug] || categorySlug;
      taxonomies.push(chineseUrl);
    }
  }
  return taxonomies;
};

// 获取分类的原始英文slug（用于过滤）
export const getTaxonomyWithOriginalSlug = async (collection: any, name: string) => {
  const singlePages = await getSinglePage(collection);
  const taxonomyPages = singlePages.map((page: any) => page.data[name]);
  const mapping: { [key: string]: string } = {};
  
  for (let i = 0; i < taxonomyPages.length; i++) {
    const categoryArray = taxonomyPages[i];
    for (let j = 0; j < categoryArray.length; j++) {
      const categoryName = categoryArray[j];
      const categorySlug = slugify(categoryName)!;
      const chineseUrl = (categoryMapping as any)[categorySlug] || categorySlug;
      mapping[chineseUrl] = categorySlug;
    }
  }
  return mapping;
};
---
